version: "3.9"

services:
  router:
    build:
      context: ./router
    platform: linux/amd64
    container_name: router
    privileged: true
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward && \
              ip route replace 10.88.10.0/24 dev eth0 && \
              ip route replace 10.88.20.0/24 dev eth1 && \
              ip route replace 10.88.30.0/24 via 10.88.40.10 && \
              sleep infinity"
    networks:
      attacker_net:
        ipv4_address: 10.88.10.254
      home_net:
        ipv4_address: 10.88.20.254
      router_firewall_net:
        ipv4_address: 10.88.40.254
  victim:
    build:
      context: ./victim
    container_name: victim
    privileged: true
    cap_add:
      - NET_ADMIN
    ports:
      - "8000:80"
    command: ["sh", "-c", "ip route replace default via 10.88.30.254 && apache2-foreground"]
    networks:
      victim_net:
        ipv4_address: 10.88.30.10

  iot:
    build:
      context: ./iot
    container_name: iot1
    privileged: true
    cap_add:
      - NET_ADMIN
    command: ["sh", "-c", "ip route replace default via 10.88.20.254 && sleep infinity"]
    networks:
      home_net:
        ipv4_address: 10.88.20.10

  attacker:
    build:
      context: ./attacker
    container_name: attacker
    privileged: true
    cap_add:
      - NET_ADMIN
    command: >
        sh -c "
        ip route add 10.88.20.0/24 via 10.88.10.254 &&
        ip route add 10.88.30.0/24 via 10.88.10.254 &&
        sleep infinity
        "
    networks:
      attacker_net:
        ipv4_address: 10.88.10.10
  splunk:
    image: splunk/splunk:latest
    platform: linux/amd64
    container_name: splunk
    environment:
     - SPLUNK_START_ARGS=--accept-license
     - SPLUNK_PASSWORD=changeme123
    ports:
      - "8001:8000"
      - "8088:8088"
      - "9997:9997"
    networks:
      attacker_net:
        ipv4_address: 10.88.10.200
      home_net:
        ipv4_address: 10.88.20.200
      victim_net:
        ipv4_address: 10.88.30.200
    privileged: true
    restart: unless-stopped

  firewall:
    build:
      context: ./firewall
    container_name: firewall
    privileged: true
    cap_add:
      - NET_ADMIN
    command: ["sh", "-c", "echo 1 > /proc/sys/net/ipv4/ip_forward && ip route replace default via 10.88.40.254 && sleep infinity"]
    networks:
      router_firewall_net:
        ipv4_address: 10.88.40.10
      victim_net:
        ipv4_address: 10.88.30.254

networks:
  attacker_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.88.10.0/24

  home_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.88.20.0/24

  victim_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.88.30.0/24

  router_firewall_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.88.40.0/24